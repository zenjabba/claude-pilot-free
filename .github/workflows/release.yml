---
name: Release

"on":
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build binaries for (e.g., 3.3.0)"
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Check if this commit should trigger a release
  check-trigger:
    name: Check Release Trigger
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check commit message
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger - proceeding"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # Check for fix: or feat: prefix
          if echo "$COMMIT_MSG" | grep -qE "^(fix|feat):"; then
            echo "Release commit detected (fix: or feat:)"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check for merge from dev branch
          if echo "$COMMIT_MSG" | grep -qE "^Merge (branch 'dev'|pull request .* from .*/dev)"; then
            echo "Merge from dev detected"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Not a release trigger commit - skipping"
          echo "should_run=false" >> "$GITHUB_OUTPUT"

  python-tests:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install git-crypt
        run: sudo apt-get update && sudo apt-get install -y git-crypt

      - name: Unlock repository
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: bash .github/workflows/scripts/setup-git-crypt.sh

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install . pytest pytest-cov pytest-asyncio

      - name: Run unit tests with coverage
        run: |
          python3 -m pytest installer/tests/unit/ launcher/tests/unit/ -v \
            --cov=installer --cov=launcher \
            --cov-report=term --cov-report=xml

  # Determine the version to release (semantic-release dry-run or manual input)
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      changelog: ${{ steps.check.outputs.changelog }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install git-crypt
        run: sudo apt-get update && sudo apt-get install -y git-crypt

      - name: Unlock repository
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: bash .github/workflows/scripts/setup-git-crypt.sh

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Check for release
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger with version ${{ inputs.version }}"
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
            echo "changelog=Manual release - no changelog generated" >> "$GITHUB_OUTPUT"
          else
            # Install semantic-release and plugins
            npm install -g semantic-release \
              @semantic-release/git \
              @semantic-release/changelog \
              @semantic-release/exec

            # Run dry-run to check if release is needed and capture changelog
            SR_OUT=/tmp/sr-output.txt
            if npx semantic-release --dry-run 2>&1 | tee $SR_OUT \
                | grep -q "Published release"; then
              VERSION=$(grep "next release version" $SR_OUT \
                | grep -oP '\d+\.\d+\.\d+' | head -1)
              if [ -z "$VERSION" ]; then
                VERSION=$(grep -oP 'Published release \K\d+\.\d+\.\d+' \
                  $SR_OUT | head -1)
              fi

              # Extract changelog/release notes from dry-run output
              CHANGELOG=$(sed -n '/Release note/,/\[semantic-release\]/p' $SR_OUT \
                | grep -v "semantic-release" | head -50 || echo "See commits for details")

              echo "Will release version: $VERSION"
              echo "should_release=true" >> "$GITHUB_OUTPUT"
              echo "version=$VERSION" >> "$GITHUB_OUTPUT"

              # Use delimiter for multiline output
              {
                echo "changelog<<EOF"
                echo "$CHANGELOG"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            else
              echo "No release needed"
              echo "should_release=false" >> "$GITHUB_OUTPUT"
              echo "version=" >> "$GITHUB_OUTPUT"
              echo "changelog=" >> "$GITHUB_OUTPUT"
            fi
          fi

  # Build jobs run in parallel after prepare-release
  build-pilot-x86:
    name: Build Pilot Linux x86_64
    runs-on: ubuntu-latest
    needs: prepare-release
    if: needs.prepare-release.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install git-crypt
        run: sudo apt-get update && sudo apt-get install -y git-crypt

      - name: Unlock repository
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: bash .github/workflows/scripts/setup-git-crypt.sh

      - name: Verify version
        run: |
          echo "Building version: ${{ needs.prepare-release.outputs.version }}"
          cat launcher/__init__.py | grep __version__

      - name: Build binary
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e BUILD_VERSION=${{ needs.prepare-release.outputs.version }} \
            python:3.12-slim-bullseye \
            bash -c "
              apt-get update && apt-get install -y binutils build-essential && \
              pip install . && \
              python -m launcher.build --release --version \$BUILD_VERSION && \
              ls -la launcher/dist/
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pilot-linux-x86_64
          path: |
            launcher/dist/pilot-linux-x86_64.so
            launcher/dist/pilot
          retention-days: 1

  build-pilot-arm64:
    name: Build Pilot Linux arm64
    runs-on: ubuntu-24.04-arm
    needs: prepare-release
    if: needs.prepare-release.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install git-crypt
        run: sudo apt-get update && sudo apt-get install -y git-crypt

      - name: Unlock repository
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: bash .github/workflows/scripts/setup-git-crypt.sh

      - name: Verify version
        run: |
          echo "Building version: ${{ needs.prepare-release.outputs.version }}"
          cat launcher/__init__.py | grep __version__

      - name: Build binary
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e BUILD_VERSION=${{ needs.prepare-release.outputs.version }} \
            python:3.12-slim-bullseye \
            bash -c "
              apt-get update && apt-get install -y binutils build-essential && \
              pip install . && \
              python -m launcher.build --release --version \$BUILD_VERSION && \
              ls -la launcher/dist/
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pilot-linux-arm64
          path: launcher/dist/pilot-linux-arm64.so
          retention-days: 1

  build-pilot-darwin-x86:
    name: Build Pilot Darwin x86_64
    runs-on: macos-15-intel
    needs: prepare-release
    if: needs.prepare-release.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install git-crypt
        run: brew install git-crypt

      - name: Unlock repository
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: bash .github/workflows/scripts/setup-git-crypt.sh

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-pyinstaller
          restore-keys: ${{ runner.os }}-pip-

      - name: Verify version
        run: |
          echo "Building version: ${{ needs.prepare-release.outputs.version }}"
          cat launcher/__init__.py | grep __version__

      - name: Build binary
        run: |
          pip install .
          python -m launcher.build --release --version ${{ needs.prepare-release.outputs.version }}
          ls -la launcher/dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pilot-darwin-x86_64
          path: launcher/dist/pilot-darwin-x86_64.so
          retention-days: 1

  build-pilot-darwin-arm64:
    name: Build Pilot Darwin arm64
    runs-on: macos-14
    needs: prepare-release
    if: needs.prepare-release.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install git-crypt
        run: brew install git-crypt

      - name: Unlock repository
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: bash .github/workflows/scripts/setup-git-crypt.sh

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-pyinstaller
          restore-keys: ${{ runner.os }}-pip-

      - name: Verify version
        run: |
          echo "Building version: ${{ needs.prepare-release.outputs.version }}"
          cat launcher/__init__.py | grep __version__

      - name: Build binary
        run: |
          pip install .
          python -m launcher.build --release --version ${{ needs.prepare-release.outputs.version }}
          ls -la launcher/dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pilot-darwin-arm64
          path: launcher/dist/pilot-darwin-arm64.so
          retention-days: 1

  # Manual approval gate - displays version and changelog, waits for approval
  approve-release:
    name: Approve Release
    runs-on: ubuntu-latest
    needs:
      - prepare-release
      - python-tests
      - build-pilot-x86
      - build-pilot-arm64
      - build-pilot-darwin-x86
      - build-pilot-darwin-arm64
    if: needs.prepare-release.outputs.should_release == 'true'
    environment: production
    steps:
      - name: Display release details for approval
        run: |
          echo "## ðŸš€ Release Approval Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version: v${{ needs.prepare-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Proposed Changelog:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.prepare-release.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python unit tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux x86_64 build ready" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux arm64 build ready" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Darwin x86_64 build ready" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Darwin arm64 build ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Approve this deployment to publish the release.**" >> $GITHUB_STEP_SUMMARY

      - name: Release approved
        run: |
          echo "âœ… Release v${{ needs.prepare-release.outputs.version }} approved!"
          echo "Proceeding to publish..."

  # Create release and upload all artifacts only after approval
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs:
      - prepare-release
      - approve-release
    if: needs.prepare-release.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install git-crypt
        run: sudo apt-get update && sudo apt-get install -y git-crypt

      - name: Unlock repository
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: bash .github/workflows/scripts/setup-git-crypt.sh

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -ls

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Create release with semantic-release
        if: github.event_name != 'workflow_dispatch'
        id: semantic
        uses: cycjimmy/semantic-release-action@v6
        with:
          extra_plugins: |
            @semantic-release/git
            @semantic-release/changelog
            @semantic-release/exec
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          echo "Uploading artifacts for v${VERSION}"

          # Wait a moment for the release to be fully created
          sleep 5

          # Upload all .so files
          gh release upload "v${VERSION}" \
            artifacts/pilot-linux-x86_64/pilot-linux-x86_64.so \
            artifacts/pilot-linux-arm64/pilot-linux-arm64.so \
            artifacts/pilot-darwin-x86_64/pilot-darwin-x86_64.so \
            artifacts/pilot-darwin-arm64/pilot-darwin-arm64.so \
            artifacts/pilot-linux-x86_64/pilot \
            --clobber

          echo "All artifacts uploaded successfully"

      - name: Output release info
        run: |
          echo "Released version: ${{ needs.prepare-release.outputs.version }}"
          echo "All platform binaries are now available"

